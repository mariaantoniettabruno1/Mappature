var flag_save = 0;
function makeArrays() {
  var e = [];
  1 == flag_save
    ? jQuery("#load_chart li").each(function() {
        var r = jQuery(this).attr("id"),
          t = (jQuery(this)
            .clone()
            .children()
            .remove()
            .end()
            .text(),
          ""),
          n = jQuery(this).parents("li");
        if (0 == n.length) {
          (t = ""), ((i = new Object())[r] = t), e.push(i);
        } else {
          for (var a = n.length - 1; a >= 0; a--) t = (n.length, n[a].id);
          var i;
          ((i = new Object())[r] = t), e.push(i);
        }
      })
    : jQuery("#org li").each(function() {
        var r = jQuery(this).attr("id"),
          t = (jQuery(this)
            .clone()
            .children()
            .remove()
            .end()
            .text(),
          ""),
          n = jQuery(this).parents("li");
        if (0 == n.length) {
          (t = ""), ((i = new Object())[r] = t), e.push(i);
        } else {
          for (var a = n.length - 1; a >= 0; a--) t = (n.length, n[a].id);
          var i;
          ((i = new Object())[r] = t), e.push(i);
        }
      }),
    saveArray(e);
}
function saveArray(e) {
  JSON.stringify(e);
  jQuery.ajax({
    type: "POST",
    url: jQuery("#org_admin_url").val(),
    data: { post_id: jQuery("#post_id").val(), tree: e, action: "save_chart" },
    success: function(e) {
      1 == flag_save ||
        2 == flag_save ||
        (jQuery(".chart_saved").fadeIn(),
        setTimeout(function() {
          jQuery(".chart_saved").fadeOut();
        }, 2e3));
    },
    error: function() {}
  });
}
jQuery(document).ready(function() {
  jQuery("span.col-shortcode").on("click", function() {
    var $temp = jQuery("<input style='position: absolute; top: -10000000px'>");
    jQuery("body").append($temp);
    console.log(jQuery(this).text());
    $temp.val(jQuery(this).text()).select();
    document.execCommand("copy");
    $temp.remove();
    jQuery(this)
      .next(".text-copied")
      .fadeIn(300)
      .delay(2000)
      .fadeOut(300);
  });
  /* Remove collapse option on org builder metabox */
  jQuery("#org_chart-data.postbox .hndle").unbind("click.postboxes");
  jQuery("#org_chart-data.postbox .handlediv").remove();
  jQuery("#org_chart-data.postbox").removeClass("closed");
  jQuery("#comboBox, #headBox, #user_dropdown").select2();
  jQuery("body").on("click", ".open-popup", function() {
    var get_element_id = jQuery(this).attr("href");
    // console.log(get_element_id);
    jQuery.magnificPopup.open({
      items: {
        src: ".jOrgChart " + get_element_id
      },
      type: "inline"
    });
  });
  jQuery("#org").jOrgChart({ chartElement: "#chart", dragAndDrop: !0 }),
    jQuery(".post-type-org_chart #publish").click(function(e) {
      (flag_save = 2), makeArrays();
    }),
    jQuery("#save_team_memeber").click(function() {
      jQuery(".admin_section_title i.fa.fa-refresh.fa-spin").show();
      var e = jQuery("input[type=checkbox]:checked")
        .map(function(e, r) {
          return jQuery(r).val();
        })
        .get();
      if ("" == e) {
        jQuery(".admin_section_title i.fa.fa-refresh.fa-spin").hide();
        return alert("Please Select Atleast One"), !1;
      }
      jQuery.ajax({
        type: "POST",
        url: jQuery("#org_admin_url").val(),
        data: { user_id: e, action: "add_team_member" },
        success: function(e) {
          jQuery(".admin_section_title i.fa.fa-refresh.fa-spin").hide(),
            jQuery(".user_update_notice").text("Users updated successfully"),
            setTimeout(function() {
              jQuery(".user_update_notice").fadeOut();
            }, 2e3),
            location.reload();
        },
        error: function() {}
      });
    }),
    jQuery(".ocp-check-non").click(function() {
      jQuery(".ocp-non-member").removeAttr("checked");
      var check_filter = jQuery(this).data("filter");
      if (check_filter != "") {
        if (jQuery(this)[0].checked) {
          jQuery(".ocp-non-member." + check_filter).attr("checked", "checked");
        } else {
          jQuery(".ocp-non-member." + check_filter).removeAttr("checked");
        }
      }
    }),
    jQuery(".ocp-uncheck-mem").click(function() {
      jQuery(".ocp-member").attr("checked", "checked");

      var check_filter = jQuery(this).data("filter");
      if (check_filter != "") {
        if (jQuery(this)[0].checked) {
          if (jQuery("." + check_filter).hasClass("ocp-member")) {
            jQuery(".ocp-member." + check_filter).removeAttr("checked");
          }
        } else {
          //  $("." + check_filter).attr("checked", "checked");
        }
      }
    }),
    jQuery("#adddep").click(function(e) {
      if ("" == jQuery("#department").val())
        return alert("please input Department Name"), !1;
      jQuery.ajax({
        type: "POST",
        url: jQuery("#org_admin_url").val(),
        data: {
          department: jQuery("#department").val(),
          action: "add_department"
        },
        success: function(e) {
          1 == e
            ? (jQuery("#department").val(""),
              alert("Department Name Already Exist"))
            : (jQuery("#dep_table").html(e), jQuery("#department").val(""));
        },
        error: function() {}
      });
    }),
    jQuery("body").on("click", ".current_dep", function(e) {
      return "" == jQuery(this).attr("dep_value")
        ? (alert("Something Wrong Please Refresh Page"), !1)
        : 1 == confirm("Are you sure?") &&
            void jQuery.ajax({
              type: "POST",
              url: jQuery("#org_admin_url").val(),
              data: {
                department: jQuery(this).attr("dep_value"),
                action: "remove_department"
              },
              success: function(e) {
                jQuery("#dep_table").html(e);
              },
              error: function() {}
            });
    }),
    jQuery("#oreset").click(function(e) {
      if (jQuery("#user_dropdown").val() == "") {
        alert("Please select a user for top level.");
        return false;
      }
      if (
        (jQuery("#reset_click").val("1"),
        1 !=
          confirm(
            "This will reset chart with selected user on top. Reset Now?"
          ))
      )
        return !1;
      console.log(jQuery("#org_admin_url").val());
      jQuery.ajax({
        type: "POST",
        url: jQuery("#org_admin_url").val(),

        data: {
          post_id: jQuery("#post_id").val(),
          user_dropdown: jQuery("#user_dropdown").val(),
          setchildren: jQuery("#setchildren").val(),
          action: "generate_chart"
        },
        success: function(e) {
          document.forms.post.submit(),
            jQuery("#load_chart").html(e),
            (flag_save = 1),
            makeArrays();
        },
        error: function() {}
      });
    }),
    wp.media.editor.send.attachment;
  function e(e, r) {
    for (var t = 0; t < e.length; t++) {
      var n = e[t].split("*");
      n[0] == r &&
        jQuery("#comboBox").append(
          '<option value="' +
            n[0] +
            "*" +
            n[1] +
            "*" +
            n[2] +
            "*" +
            n[3] +
            '">' +
            n[3] +
            "</option>"
        );
    }
  }

  jQuery(".shr-image").click(function() {
    var e = jQuery(this),
      r = jQuery(this).attr("data-id"),
      t = jQuery(this).attr("data-src");
    return (
      (wp.media.editor.send.attachment = function(e, n) {
        if ("image" !== n.type)
          return alert("Please select a valid image file"), !1;
        if (-1 !== t.indexOf(",")) {
          (t = t.split(",")),
            ($image_ids = ""),
            jQuery.each(t, function(e, r) {
              $image_ids
                ? ($image_ids = $image_ids + ",#" + r)
                : ($image_ids = "#" + r);
            });
          var a = jQuery($image_ids);
        } else a = jQuery("#" + t);
        jQuery("#" + r).val(n.id), a.attr("src", n.url).show();
      }),
      wp.media.editor.open(e),
      !1
    );
  }),
    jQuery("#btnAddOrg").click(function() {
      jQuery("#comboBox option:selected").text();
      var e = jQuery("#comboBox option:selected").val();
      if ("" != e) {
        var r = e.split("*");
        jQuery("ul#org > li > ul").length
          ? jQuery("ul#org > li > ul").append(
              (function(e) {
                return (
                  '<li id="' +
                  e[0] +
                  '"><img src="' +
                  e[1] +
                  '" /><a class="rmv-nd close" href="javascript:void(0);">Remove</a><span id="' +
                  e[0] +
                  '" class="name_c">' +
                  e[3] +
                  "</span><small>" +
                  e[2] +
                  "</small></li>"
                );
              })(r)
            )
          : jQuery("ul#org > li").append(
              (function(e) {
                return (
                  '<ul id="2"><li id="' +
                  e[0] +
                  '"><img src="' +
                  e[1] +
                  '" /><a class="rmv-nd close" href="javascript:void(0);">Remove</a><span id="' +
                  e[0] +
                  '" class="name_c">' +
                  e[3] +
                  "</span><small>" +
                  e[2] +
                  "</small></li></ul>"
                );
              })(r)
            ),
          jQuery(".jOrgChart").remove(),
          jQuery("#org").jOrgChart({ chartElement: "#chart", dragAndDrop: !0 }),
          jQuery("#comboBox option:selected").remove(),
          0 === jQuery("#comboBox option:enabled").length &&
            jQuery("#btnAddOrg").attr("disabled", !0);
      }
    }),
    jQuery("#set_top_user").click(function(r) {
      r.preventDefault();
      var t = jQuery("#comboBox option:selected").text(),
        n = jQuery("#comboBox option:selected").val(),
        a = jQuery("ul#org > li").attr("id");
      if ("" != n) {
        t = (s = n.split("*"))[3];
        var i = s[1],
          l = s[2],
          o = jQuery("ul#org > li > ul").html();
        jQuery("ul#org ").html(
          '<li id="' +
            s[0] +
            '"><img src="' +
            i +
            '" /><span id="' +
            s[0] +
            '" class="name_c">' +
            t +
            "</span><small>" +
            l +
            "</small><ul id='2'></ul></li>"
        ),
          jQuery("ul#org > li > ul").append(o);
        var s;
        e(
          (s = jQuery("#hidden_val")
            .val()
            .split("$")),
          a
        ),
          jQuery(".jOrgChart").remove(),
          jQuery("#org").jOrgChart({ chartElement: "#chart", dragAndDrop: !0 }),
          jQuery("#comboBox option:selected").remove(),
          0 === jQuery("#comboBox option:enabled").length &&
            jQuery("#btnAddOrg").attr("disabled", !0);
      }
    }),
    jQuery("#addHead").click(function() {
      var name = jQuery("#headBox option:selected").text();
      var val = jQuery("#headBox option:selected").val();

      if (val != "") {
        if (jQuery("ul#org > li > ul").length) {
          jQuery("ul#org > li > ul").append(
            '<li id="' +
              val +
              '">' +
              '<a class="rmv-nd close" href="javascript:void(0);">Remove</a>' +
              '<span id="' +
              val +
              '" class="name_c org_dept">' +
              name +
              "</span></li>"
          );
        } else {
          jQuery("ul#org > li").append(
            '<ul id="2"><li id="' +
              val +
              '">' +
              '<a class="rmv-nd close" href="javascript:void(0);">Remove</a>' +
              '<span id="' +
              val +
              '" class="name_c org_dept">' +
              name +
              "</span></li></ul>"
          );
        }
      }
      jQuery(".jOrgChart").remove(),
        jQuery("#org").jOrgChart({ chartElement: "#chart", dragAndDrop: !0 }),
        0 === jQuery("#headBox option:enabled").length &&
          jQuery("#addHead").attr("disabled", !0);
    }),
    jQuery("body").on("click", ".jOrgChart a.rmv-nd", function() {
      var r = jQuery(this)
        .parent()
        .find(".name_c")
        .attr("id");
      e(
        jQuery("#hidden_val")
          .val()
          .split("$"),
        r
      );
      var t = jQuery("#org #" + r)
        .children("ul")
        .html();
      jQuery("#org #" + r)
        .closest("ul")
        .append(t),
        jQuery("#org #" + r).remove(),
        jQuery(".jOrgChart").remove(),
        jQuery("#org").jOrgChart({ chartElement: "#chart", dragAndDrop: !0 });
    });
});
var isMobile = {
  Android: function() {
    return navigator.userAgent.match(/Android/i);
  },
  BlackBerry: function() {
    return navigator.userAgent.match(/BlackBerry/i);
  },
  iOS: function() {
    return navigator.userAgent.match(/iPhone|iPad|iPod/i);
  },
  Opera: function() {
    return navigator.userAgent.match(/Opera Mini/i);
  },
  Windows: function() {
    return (
      navigator.userAgent.match(/IEMobile/i) ||
      navigator.userAgent.match(/WPDesktop/i)
    );
  },
  any: function() {
    return (
      isMobile.Android() ||
      isMobile.BlackBerry() ||
      isMobile.iOS() ||
      isMobile.Opera() ||
      isMobile.Windows()
    );
  }
};
if (isMobile.any()) {
  var disable_counter = 1,
    main_counter = 1;
  jQuery(document).ready(function() {
    jQuery(".jOrgChart tr td.node-container").each(function() {
      jQuery(this)
        .find("td.node-container")
        .parent()
        .slideUp(),
        jQuery(this)
          .find("td.node-container")
          .parent()
          .prevUntil("tr.node-cells")
          .slideUp(),
        jQuery(this)
          .find("tr.node-cells")
          .next().length < 1 ||
          (jQuery(this)
            .find("tr.node-cells td")
            .find(".downarrow").length < 1 &&
            (jQuery(this)
              .find("tr.node-cells td")
              .append("<div class='downarrow " + main_counter + "'></div>"),
            main_counter++));
    }),
      jQuery("body").on("click", "div.downarrow", function() {
        jQuery(this)
          .parents(".node-container")
          .first()
          .nextAll()
          .each(function() {
            jQuery(this)
              .find("tr.node-cells")
              .nextAll()
              .slideUp(),
              jQuery(this)
                .find("tr.node-cells")
                .nextAll()
                .removeClass("showing");
          }),
          jQuery(this)
            .parents(".node-container")
            .first()
            .prevAll()
            .each(function() {
              jQuery(this)
                .find("tr.node-cells")
                .nextAll()
                .slideUp(),
                jQuery(this)
                  .find("tr.node-cells")
                  .nextAll()
                  .removeClass("showing");
            }),
          jQuery(this)
            .closest("tr.node-cells")
            .nextAll()
            .hasClass("showing")
            ? (jQuery(this)
                .closest("tr.node-cells")
                .nextAll()
                .slideUp(),
              jQuery(this)
                .closest("tr.node-cells")
                .next("td.node-container")
                .slideUp(),
              jQuery(this)
                .closest("tr.node-cells")
                .nextAll()
                .removeClass("showing"),
              jQuery(this)
                .closest("tr.node-cells")
                .parent("table")
                .find("tr")
                .slideUp(),
              jQuery(this)
                .parent()
                .nextAll()
                .eq(2)
                .find("td.node-container")
                .slideUp(),
              jQuery(this)
                .closest("tr.node-cells")
                .nextAll()
                .each(function() {
                  3 == disable_counter &&
                    (jQuery(this)
                      .find("tr.node-cells")
                      .nextAll()
                      .slideUp(),
                    (disable_counter = 1)),
                    disable_counter++;
                }))
            : (jQuery(this)
                .closest("tr.node-cells")
                .nextAll()
                .slideDown(),
              jQuery(this)
                .closest("tr.node-cells")
                .nextAll()
                .addClass("showing"),
              jQuery(this)
                .next()
                .find("td.node-container:first-child")
                .slideDown());
      }),
      jQuery(".jOrgChart tr.node-cells td .downarrow").each(function() {
        jQuery(this)
          .closest("tr.node-cells")
          .next("tr").length < 1 && jQuery(this).hide();
      });
  });
}
